{% extends 'base.html' %}
{% load static %}
{% block mainbody %}
<script>
  const isNullOrUndefined = obj => obj === null || obj === undefined;
  $(document).ready(function () {
    $.ajaxSetup({
      data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
    });
  });
</script>
<div class="row">
  <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 col-xl-12">
    <div class="card mb-3">
      <div class="card-body">
        <div style="float: left;width: 100%;">
          <div id="bar_fig"></div>
          <!--血压哑铃图-->
          <div class="row">
            <div class="col-sm-10">
              <div id="blood_pressure_fig"></div>
            </div>
            <!--选择框-->
            <div class="col-sm-2">
              <div style="margin-top: 50px;">
                <div class="radio">
                  <label>
                    <input type="radio" name="optionsRadios" id="optionsRadios1" value="0" checked>按ID升序
                  </label>
                  <label>
                    <input type="radio" name="optionsRadios" id="optionsRadios2" value="7">按年龄升序
                  </label>
                  <label>
                    <input type="radio" name="optionsRadios" id="optionsRadios2" value="9">按BMI升序
                  </label>
                </div>
              </div>
            </div>
            <!--end血压哑铃图-->
          </div>

          <!-- 选项卡区-->

        </div>
        <!--
          <div style="float: left">
          <div id="scatter_fig"></div>
        </div>
        -->
        <!--关系图-->
        <div style="float: left">
          <div id="disease_relationship_fig"></div>
        </div>


      </div>
      <!--
        <div class="card-body">
        <div>
          <div style="float: left">
            <div id="biochemical_indexes_fig"></div>
          </div>
          <div style="float: left">
            <div id="parallel_fig"></div>
          </div>
        </div>
      </div>
      -->

    </div>
  </div>
  {% block ralationbody %}
  {% endblock ralationbody %}
</div>
<script src="{% static 'js/my_echart/options.js' %}"></script>
<script type="text/javascript">
  //并发症柱状图
  let bar_fig = echarts.init(document.getElementById('bar_fig'));
  bar_fig.resize({
    width: 800,
    height: 300
  });
  let bar_data = {{ num_diabetes_complication| safe }};
  bar_fig.setOption(barLineOption(bar_data, 5));
  /*bar_fig.on('legendselectchanged', function (params) {
    male = params.selected['男性患并发症'] || params.selected['男性无并发症'];
    female = params.selected['女性患并发症'] || params.selected['女性无并发症'];
    if (male && female) {
      bar_fig.setOption(barLineOption(bar_data, 5));
    } else if (female) {
      bar_fig.setOption(barLineOption(bar_data, 6));
    } else if (male) {
      bar_fig.setOption(barLineOption(bar_data, 7));
    }

  });
  bar_fig.on('datazoom', function (params) {
    let index = bar_fig._chartsMap["_ec_\u0000患病比例\u00000_series.line"]._data._approximateExtent.x;
    $.ajax({
      type: "POST",
      data: { left: index[0], right: index[1] },
      url: "{% url 'num_diabetes_complication' %}",
      cache: false,
      success: function (result) {
        let option = {
          series: [
            {
              name: "女性",
              data: result.data[0]
            },
            {
              name: "男性",
              data: result.data[1]
            },
          ]
        };
      },
      error: function (XMLHttpRequest, textStatus) {
        alert("ajax: " + textStatus);
      }
    });
  });*/

  /*
  let scatter_fig = echarts.init(document.getElementById('scatter_fig'));
  scatter_fig.resize({
    width: 600,
    height: 300
  });
  scatter_fig.setOption(scatterOption({{ scatterData| safe }}));
*/
  //血压哑铃图
  let blood_pressure_fig = echarts.init(document.getElementById('blood_pressure_fig'));
  blood_pressure_fig.resize({
    width: 800,
    height: 410
  });

  //isXLabel判断是在x轴还是在对象上
  var isXLabel = false
  //点击跳转到详情页
  blood_pressure_fig.on('click', function (params) {
    if (params.componentType == 'xAxis') {
      console.log('click', params.value)
      //页面跳转  ? 分隔实际的URL和参数 
      window.location.href = `individual?id=${params.value}`
    }
  });
  //hover显示按钮
  blood_pressure_fig.on('mousemove', function (params) {
    //当鼠标在x轴上时
    if (params.componentType == 'xAxis') {
      isXLabel = true;
      //记下位置
      var offsetX = params.event.offsetX + 10;
      var offsetY = params.event.offsetY + 10;
      //附上提示框
      blood_pressure_fig.dispatchAction({
        type: 'showTip',
        seriesIndex: 0,
        dataIndex: params.value - 1,
        position: [offsetX, offsetY]
      });
    }

  });
  blood_pressure_fig.on('mouseover', function (params) {
    isXLabel = false;
  });

  var bloodPressureData = {{ bloodPressureData| safe }};
  bar_fig.on('datazoom', function (params) {
    bloodPressureData1 = []
    let small = params.start / 8.33
    let big = params.end / 8.33
    let smalledge = 0
    let bigedge = 120
    if (small < 1) {
      smalledge = 0
    } else if (small < 3) {
      smalledge = 20
    }
    else if (small < 5) {
      smalledge = 30
    }
    else if (small < 7) {
      smalledge = 40
    }
    else if (small < 9) {
      smalledge = 50
    }
    else if (small < 11) {
      smalledge = 60
    }
    else {
      smalledge = 70
    }

    if (big > 11) {
      bigedge = 120
    } else if (big > 9) {
      bigedge = 71
    }
    else if (big > 7) {
      bigedge = 61
    }
    else if (big > 5) {
      bigedge = 51
    }
    else if (big > 3) {
      bigedge = 41
    }
    else if (big > 1) {
      bigedge = 31
    }
    else {
      bigedge = 21
    }
    for (let i = 0; i < bloodPressureData.length; i++) {
      if (bloodPressureData[i][7] > smalledge && bloodPressureData[i][7] < bigedge) {
        bloodPressureData1.push(bloodPressureData[i])
      }
    }
    blood_pressure_fig.setOption(bloodPressureOption(bloodPressureData1), true);
  });
  let bloodPressureOption_option = bloodPressureOption(bloodPressureData)
  //协同缩放

  blood_pressure_fig.setOption(bloodPressureOption_option);
  //疾病关系图
  /*let disease_relationship_fig = echarts.init(document.getElementById('disease_relationship_fig'));
  disease_relationship_fig.resize({
    width: 800,
    height: 600
  });
  let diseaseRelationshipData = {{ diseaseRelationshipData| safe }};
  //console.log(diseaseRelationshipData)
  disease_relationship_fig.setOption(diseaseRelationshipOption(diseaseRelationshipData));*/
  /*
  let biochemical_indexes_fig = echarts.init(document.getElementById('biochemical_indexes_fig'));
  biochemical_indexes_fig.resize({
    width: 500,
    height: 250
  });
  let biochemicalIndexesData = {{ biochemicalIndexesData| safe }};
  biochemical_indexes_fig.setOption(biochemicalIndexesOption(biochemicalIndexesData));

  let parallel_fig = echarts.init(document.getElementById('parallel_fig'));
  parallel_fig.resize({
    width: 800,
    height: 250
  });
  parallel_fig.setOption(parallelOption());*/
  $('input[type=radio][name=optionsRadios]').change(function () {
    if (this.value == '0') {
      bloodPressureData.sort(function (a, b) {
        return a[0] - b[0]
      })
    } else
      if (this.value == '7') {
        bloodPressureData.sort(function (a, b) {
          return a[7] - b[7]
        })
      }
      else
        if (this.value == '9') {
          bloodPressureData.sort(function (a, b) {
            return a[9] - b[9]
          })
        }
    blood_pressure_fig.setOption(bloodPressureOption(bloodPressureData), true)
  });

</script>
{% endblock %}